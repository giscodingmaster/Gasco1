<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GASCO Location Collector (New Schema)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Cairo', 'Inter', 'sans-serif';
            background-color: #f8fafc;
        }
        .btn {
            @apply font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200 ease-in-out transform hover:shadow-lg hover:-translate-y-px focus:outline-none focus:ring-2 focus:ring-offset-2 border border-transparent;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500 disabled:opacity-60 disabled:cursor-not-allowed;
        }
        .btn-secondary {
            @apply bg-white text-slate-700 border border-slate-300 hover:bg-slate-50 focus:ring-slate-300;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-700 focus:ring-red-500;
        }
        .btn-export {
            @apply bg-emerald-600 text-white hover:bg-emerald-700 focus:ring-emerald-500 disabled:opacity-60 disabled:cursor-not-allowed;
        }
        .table-header-cell {
            @apply px-4 py-3 text-right text-xs font-bold text-slate-600 uppercase tracking-wider bg-slate-50 border-b border-slate-200;
        }
        .table-body-cell {
            @apply px-4 py-3 whitespace-nowrap border-b border-slate-100;
        }
        .tab-button {
            @apply whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm transition-colors duration-200;
        }
        .tab-button-active {
            @apply border-blue-500 text-blue-600;
        }
        .tab-button-inactive {
            @apply border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300;
        }
        /* Print Styles for QR */
        @media print {
            body * { visibility: hidden; }
            .printable-area, .printable-area * { visibility: visible; }
            .printable-area {
                position: absolute; left: 0; top: 0; width: 100%; height: 100%;
                display: flex; flex-direction: column; align-items: center; justify-content: center;
            }
            .no-print { display: none !important; }
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>
    
    <script type="module">
        import React from 'react';
        import ReactDOM from 'react-dom/client';
        const e = React.createElement;

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyA2VDO_vXe8q5Pfon2BGPoL3tD0IKbkBhg",
          authDomain: "students-grade-management.firebaseapp.com",
          databaseURL: "https://students-grade-management-default-rtdb.firebaseio.com",
          projectId: "students-grade-management",
          storageBucket: "students-grade-management.firebasestorage.app",
          messagingSenderId: "888502840503",
          appId: "1:888502840503:web:e82b7ca4e38b13e4053132",
          measurementId: "G-C4GT0V5C0V"
        };
        
        if (!window.firebase.apps.length) {
            window.firebase.initializeApp(firebaseConfig);
        }

        // =====================================================================================
        // --- COORD CONVERSION SETUP (UTM Zone 36N) ---
        // =====================================================================================
        if (window.proj4) {
            window.proj4.defs("EPSG:32636", "+proj=utm +zone=36 +datum=WGS84 +units=m +no_defs");
        }

        function convertToUTM(lat, lon) {
            if (!window.proj4) return { x: 0, y: 0 };
            const result = window.proj4("EPSG:4326", "EPSG:32636", [lon, lat]);
            return { x: result[0], y: result[1] };
        }

        // =====================================================================================
        // --- UTILITIES ---
        // =====================================================================================
        function extractCoordinates(urlInput) {
            if (!urlInput) return null;
            let url = decodeURIComponent(urlInput).replace(/\s/g, '');
            const patterns = [
                /!3d(-?\d+(?:\.\d+)?)!4d(-?\d+(?:\.\d+)?)/,
                /@(-?\d+(?:\.\d+)?),(-?\d+(?:\.\d+)?)/,
                /q=(-?\d+(?:\.\d+)?),(-?\d+(?:\.\d+)?)/,
                /ll=(-?\d+(?:\.\d+)?),(-?\d+(?:\.\d+)?)/
            ];
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match.length >= 3) {
                    const lat = parseFloat(match[1]);
                    const lon = parseFloat(match[2]);
                    if (!isNaN(lat) && !isNaN(lon) && lat >= -90 && lat <= 90) return { lat, lon };
                }
            }
            return null;
        }

        // --- NEW COLUMN MAPPING BASED ON PROVIDED SCHEMA ---
        const COLS = {
            CLIENT: 'اسم_المنشأة',
            SAP_CODE: 'كود_ساب_إيجاس',
            PETRO_CODE: 'كود_بتروتريد',
            GOV: 'gove_name',
            ACTIVITY: 'نوع_النشاط',
            CAPACITY: 'كميات_الغاز_الصادر__بها_موافقة',
            START_DATE: 'تاريخ_بداية_العقد'
        };

        // Helper for Excel Dates
        const excelDateToJSDate = (serial) => {
            if (!serial) return '';
            if (typeof serial === 'string') return serial;
            const utc_days  = Math.floor(serial - 25569);
            const utc_value = utc_days * 86400;                                        
            const date_info = new Date(utc_value * 1000);
            return date_info.toLocaleDateString('ar-EG');
        };

        // =====================================================================================
        // --- COMPONENTS ---
        // =====================================================================================
        
        const Alert = ({ message, type }) => {
            const colors = type === 'error' ? 'bg-red-50 text-red-800 border-red-200' : 'bg-green-50 text-green-800 border-green-200';
            return e('div', { className: `p-4 mb-4 rounded border ${colors}` }, message);
        };

        const Header = ({ title, count }) => e('header', { className: "bg-slate-800 text-white py-4 shadow-md" },
            e('div', { className: "container mx-auto px-4 flex justify-between items-center" },
                e('h1', { className: "text-xl font-bold" }, title),
                e('span', { className: "bg-white/20 px-3 py-1 rounded-full text-sm" }, count)
            )
        );

        const MainApp = () => {
            const { useState, useEffect, useMemo } = React;
            
            // State
            const [isAdmin, setIsAdmin] = useState(false);
            const [passInput, setPassInput] = useState('');
            const [showLogin, setShowLogin] = useState(false);
            
            const [refData, setRefData] = useState([]); 
            const [fileName, setFileName] = useState('');
            const [collected, setCollected] = useState([]);
            
            const [selGov, setSelGov] = useState('');
            const [selIndex, setSelIndex] = useState('');
            const [gMapLink, setGMapLink] = useState('');
            const [coords, setCoords] = useState(null);
            const [utm, setUtm] = useState(null);
            
            const [alert, setAlert] = useState(null);
            const [activeTab, setActiveTab] = useState('pending');
            const [editId, setEditId] = useState(null);
            const [qrData, setQrData] = useState(null);

            // --- Effects ---
            useEffect(() => {
                const db = window.firebase.database();
                // We use 'masterReference' node. If schema changed drastically, 
                // you might want to clear old data or use a new node.
                db.ref('masterReference').on('value', snap => {
                    const val = snap.val();
                    if (val && val.data) {
                        setRefData(val.data);
                        setFileName(val.fileName);
                    } else { setRefData([]); }
                });
                db.ref('collectedLocations').on('value', snap => {
                    const val = snap.val();
                    const list = [];
                    if (val) Object.keys(val).forEach(key => list.push({ firebaseId: key, ...val[key] }));
                    list.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    setCollected(list);
                });
            }, []);

            useEffect(() => {
                if (qrData) {
                    setTimeout(() => {
                        const canvas = document.getElementById('qr-canvas');
                        if (canvas && window.QRCode) {
                            // Using SAP code and coords in QR
                            const qrContent = `Client:${qrData.commercialCode}\nLat:${qrData.latitude}\nLon:${qrData.longitude}`;
                            window.QRCode.toCanvas(canvas, qrContent, { width: 200 }, (err) => { if (err) console.error(err); });
                        }
                    }, 100);
                }
            }, [qrData]);

            // --- Helpers ---
            const showAlert = (msg, type = 'success') => {
                setAlert({ message: msg, type });
                setTimeout(() => setAlert(null), 4000);
            };

            const normalizeKeys = (row) => {
                // Direct mapping based on new schema
                return {
                    id: row['UniqueID'],
                    clientName: row[COLS.CLIENT] || 'Unknown',
                    commercialCode: row[COLS.SAP_CODE] || row[COLS.PETRO_CODE] || '_',
                    petroCode: row[COLS.PETRO_CODE] || '',
                    governorate: row[COLS.GOV] || 'Unknown',
                    activity: row[COLS.ACTIVITY] || '',
                    capacity: row[COLS.CAPACITY] || '',
                    startDate: excelDateToJSDate(row[COLS.START_DATE]),
                    ...row 
                };
            };

            // --- Handlers ---
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, { type: 'array' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        // raw: false ensures dates are parsed somewhat, but for safety lets keep raw values
                        const json = XLSX.utils.sheet_to_json(ws); 
                        if (!json.length) throw new Error("Empty file");

                        const processed = json.map((row, idx) => {
                            const newRow = {};
                            Object.keys(row).forEach(key => {
                                // Clean keys just in case
                                let safeKey = key.trim(); 
                                newRow[safeKey] = row[key];
                            });
                            newRow.UniqueID = idx;
                            return newRow;
                        });

                        window.firebase.database().ref('masterReference').set({
                            fileName: file.name,
                            data: processed,
                            updatedAt: new Date().toISOString()
                        }).then(() => showAlert("تم رفع الملف المرجعي الجديد بنجاح"));
                    } catch (err) { showAlert("خطأ في قراءة الملف: " + err.message, 'error'); }
                };
                reader.readAsArrayBuffer(file);
            };

            const handleLogin = (e) => {
                e.preventDefault();
                if (passInput === 'admin123') {
                    setIsAdmin(true); setShowLogin(false); showAlert("تم تسجيل الدخول كمسؤول");
                } else { showAlert("كلمة المرور غير صحيحة", 'error'); }
            };

            const handleLinkChange = (val) => {
                setGMapLink(val);
                const extracted = extractCoordinates(val);
                setCoords(extracted);
                
                if (extracted) {
                    const utmVal = convertToUTM(extracted.lat, extracted.lon);
                    setUtm(utmVal);
                } else {
                    setUtm(null);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!coords || selIndex === '') {
                    showAlert("تأكد من اختيار العميل ورابط صحيح", 'error');
                    return;
                }

                const masterRecord = refData[parseInt(selIndex)];
                const norm = normalizeKeys(masterRecord);

                const payload = {
                    masterRefId: masterRecord.UniqueID,
                    clientName: norm.clientName,
                    commercialCode: norm.commercialCode, // SAP Code
                    petroCode: norm.petroCode,
                    activity: norm.activity,
                    governorate: norm.governorate,
                    latitude: coords.lat.toFixed(6),
                    longitude: coords.lon.toFixed(6),
                    utmX: utm ? utm.x.toFixed(2) : '',
                    utmY: utm ? utm.y.toFixed(2) : '',
                    utmZone: '36N',
                    timestamp: new Date().toISOString()
                };

                const db = window.firebase.database();
                if (editId) {
                    db.ref(`collectedLocations/${editId}`).update(payload)
                        .then(() => { showAlert("تم تعديل البيانات"); resetForm(); });
                } else {
                    db.ref('collectedLocations').push(payload)
                        .then(() => { showAlert("تم حفظ الموقع"); resetForm(); });
                }
            };

            const resetForm = () => {
                setSelIndex(''); setGMapLink(''); setCoords(null); setUtm(null); setEditId(null);
            };

            const handleEdit = (rec) => {
                setEditId(rec.firebaseId);
                const idx = refData.findIndex(r => r.UniqueID === rec.masterRefId);
                setSelIndex(idx.toString());
                const r = refData[idx];
                const norm = normalizeKeys(r);
                setSelGov(norm.governorate);
                setGMapLink(`http://googleusercontent.com/maps.google.com/?q=${rec.latitude},${rec.longitude}`);
                setCoords({ lat: parseFloat(rec.latitude), lon: parseFloat(rec.longitude) });
                
                if (rec.utmX && rec.utmY) {
                    setUtm({ x: parseFloat(rec.utmX), y: parseFloat(rec.utmY) });
                } else {
                    const u = convertToUTM(parseFloat(rec.latitude), parseFloat(rec.longitude));
                    setUtm(u);
                }
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const handleDelete = (id) => {
                if(confirm("حذف هذا السجل؟")) window.firebase.database().ref(`collectedLocations/${id}`).remove();
            };

            const exportExcel = () => {
                const map = {};
                collected.forEach(c => map[c.masterRefId] = c);

                const output = refData.map(row => {
                    const c = map[row.UniqueID];
                    return {
                        ...row,
                        'Lat (WGS84)': c ? c.latitude : '',
                        'Lon (WGS84)': c ? c.longitude : '',
                        'UTM X (36N)': c ? c.utmX : '',
                        'UTM Y (36N)': c ? c.utmY : '',
                        'Collection_Date': c ? new Date(c.timestamp).toLocaleDateString('ar-EG') : ''
                    };
                });

                const ws = XLSX.utils.json_to_sheet(output);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Data_UTM36N");
                XLSX.writeFile(wb, "Gasco_Locations_UTM.xlsx");
            };

            const exportGeoJSON = () => {
                const features = collected.map(c => ({
                    type: "Feature",
                    geometry: { type: "Point", coordinates: [parseFloat(c.longitude), parseFloat(c.latitude)] },
                    properties: { name: c.clientName, sapCode: c.commercialCode, gov: c.governorate, activity: c.activity }
                }));
                const geo = { type: "FeatureCollection", features };
                const blob = new Blob([JSON.stringify(geo)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = "locations.geojson";
                a.click();
            };

            // --- Derived State ---
            const govs = useMemo(() => {
                const s = new Set();
                refData.forEach(r => {
                    // Normalize just to check key existence safely
                    const val = r[COLS.GOV];
                    if(val) s.add(val.toString().trim());
                });
                return Array.from(s).sort();
            }, [refData]);

            const filteredClients = useMemo(() => {
                if (!selGov) return [];
                const collectedIds = new Set(collected.map(c => c.masterRefId));
                return refData
                    .map((r, i) => ({ ...normalizeKeys(r), originalIndex: i }))
                    .filter(r => r.governorate.toString().trim() === selGov)
                    .map(r => ({ ...r, isDone: collectedIds.has(r.UniqueID) }));
            }, [selGov, refData, collected]);

            const pendingList = useMemo(() => {
                const collectedIds = new Set(collected.map(c => c.masterRefId));
                return refData.map(r => normalizeKeys(r)).filter(r => !collectedIds.has(r.id));
            }, [refData, collected]);

            const selectedItem = useMemo(() => {
                if (selIndex === '') return null;
                return normalizeKeys(refData[parseInt(selIndex)]);
            }, [selIndex, refData]);

            // --- Render ---
            return e(React.Fragment, null,
                e(Header, { title: "نظام جمع إحداثيات العملاء - الجديد", count: `${collected.length} / ${refData.length}` }),
                
                showLogin && e('div', { className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50" },
                    e('div', { className: "bg-white p-6 rounded-lg shadow-xl w-96" },
                        e('h2', { className: "text-lg font-bold mb-4" }, "دخول المشرف"),
                        e('form', { onSubmit: handleLogin },
                            e('input', { type: "password", className: "w-full border p-2 rounded mb-4", placeholder: "كلمة المرور", value: passInput, onChange: e => setPassInput(e.target.value) }),
                            e('div', { className: "flex justify-end gap-2" },
                                e('button', { type: "button", onClick: () => setShowLogin(false), className: "btn btn-secondary" }, "إلغاء"),
                                e('button', { type: "submit", className: "btn btn-primary" }, "دخول")
                            )
                        )
                    )
                ),

                qrData && e('div', { className: "fixed inset-0 bg-black/60 flex items-center justify-center z-50", onClick: () => setQrData(null) },
                    e('div', { className: "bg-white p-8 rounded-xl shadow-2xl text-center printable-area", onClick: e => e.stopPropagation() },
                        e('h3', { className: "text-xl font-bold mb-2 text-slate-800" }, qrData.clientName),
                        e('p', { className: "text-sm text-slate-500 mb-4" }, `SAP: ${qrData.commercialCode} | Act: ${qrData.activity}`),
                        e('canvas', { id: "qr-canvas", className: "mx-auto border p-2 rounded" }),
                        e('div', { className: "mt-4 text-sm font-mono text-slate-600 text-left dir-ltr" },
                            e('div', null, `Lat: ${qrData.latitude}`),
                            e('div', null, `Lon: ${qrData.longitude}`),
                            e('div', { className: "mt-1 pt-1 border-t" }, `X: ${qrData.utmX}`),
                            e('div', null, `Y: ${qrData.utmY}`)
                        ),
                        e('div', { className: "mt-6 flex justify-center gap-2 no-print" },
                            e('button', { className: "btn btn-secondary", onClick: () => setQrData(null) }, "إغلاق"),
                            e('button', { className: "btn btn-primary", onClick: () => window.print() }, "طباعة")
                        )
                    )
                ),

                e('div', { className: "container mx-auto p-4 grid grid-cols-1 lg:grid-cols-3 gap-6" },
                    e('div', { className: "lg:col-span-1 space-y-6" },
                        alert && e(Alert, { message: alert.message, type: alert.type }),

                        e('div', { className: "bg-white p-6 rounded-xl shadow-sm border border-slate-100" },
                            e('div', { className: "flex justify-between items-center mb-4" },
                                e('h2', { className: "font-bold text-lg text-slate-700" }, "إدخال البيانات"),
                                !isAdmin ? 
                                    e('button', { onClick: () => setShowLogin(true), className: "text-sm text-blue-600 font-semibold" }, "دخول مشرف") :
                                    e('button', { onClick: () => setIsAdmin(false), className: "text-sm text-red-600" }, "خروج")
                            ),

                            isAdmin && e('div', { className: "mb-6 p-4 bg-slate-50 rounded-lg border border-dashed border-slate-300" },
                                e('label', { className: "block text-sm font-medium text-slate-700 mb-2" }, "تحديث قاعدة البيانات (Excel)"),
                                e('input', { type: "file", accept: ".xlsx", onChange: handleFileUpload, className: "block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" }),
                                fileName && e('p', { className: "text-xs text-green-600 mt-2" }, `الملف الحالي: ${fileName}`)
                            ),

                            refData.length > 0 ? e('form', { onSubmit: handleSubmit, className: "space-y-4" },
                                e('div', null,
                                    e('label', { className: "block text-sm font-medium mb-1" }, "1. المحافظة"),
                                    e('select', { className: "w-full p-2 border rounded bg-slate-50", value: selGov, onChange: e => { setSelGov(e.target.value); setSelIndex(''); } },
                                        e('option', { value: "" }, "-- اختر المحافظة --"),
                                        govs.map(g => e('option', { key: g, value: g }, g))
                                    )
                                ),
                                e('div', null,
                                    e('label', { className: "block text-sm font-medium mb-1" }, "2. العميل"),
                                    e('select', { className: "w-full p-2 border rounded bg-slate-50", disabled: !selGov, value: selIndex, onChange: e => setSelIndex(e.target.value) },
                                        e('option', { value: "" }, "-- اختر العميل --"),
                                        filteredClients.map(c => 
                                            e('option', { key: c.originalIndex, value: c.originalIndex, className: c.isDone ? 'text-green-600' : '' }, 
                                                `${c.isDone ? '✓ ' : ''}${c.clientName} - ${c.activity} (${c.commercialCode})`
                                            )
                                        )
                                    )
                                ),

                                selectedItem && e('div', { className: "bg-blue-50 p-3 rounded text-sm text-blue-800 space-y-1" },
                                    e('p', null, e('span', { className: "font-bold" }, "SAP كود: "), selectedItem.commercialCode),
                                    e('p', null, e('span', { className: "font-bold" }, "كود بتروتريد: "), selectedItem.petroCode),
                                    e('p', null, e('span', { className: "font-bold" }, "النشاط: "), selectedItem.activity),
                                    e('p', null, e('span', { className: "font-bold" }, "كميات الغاز: "), selectedItem.capacity),
                                    e('p', null, e('span', { className: "font-bold" }, "بداية العقد: "), selectedItem.startDate)
                                ),

                                e('div', null,
                                    e('label', { className: "block text-sm font-medium mb-1" }, "3. رابط Google Maps"),
                                    e('input', { type: "text", className: "w-full p-2 border rounded", placeholder: "الصق الرابط الكامل هنا...", value: gMapLink, onChange: (e) => handleLinkChange(e.target.value) }),
                                    e('p', { className: "text-xs text-slate-500 mt-1" }, "يدعم الروابط المباشرة (place, search, pin).")
                                ),

                                coords && e('div', { className: "space-y-2" },
                                    e('div', { className: "bg-green-50 text-green-800 p-2 rounded text-center text-sm font-mono border border-green-200" }, 
                                        e('div', {className: "font-bold text-xs text-green-600 uppercase"}, "Geographic (WGS84)"),
                                        `Lat: ${coords.lat.toFixed(6)}`, e('br'), `Lon: ${coords.lon.toFixed(6)}`
                                    ),
                                    utm && e('div', { className: "bg-indigo-50 text-indigo-800 p-2 rounded text-center text-sm font-mono border border-indigo-200" }, 
                                        e('div', {className: "font-bold text-xs text-indigo-600 uppercase"}, "Projected (UTM 36N)"),
                                        `X: ${utm.x.toFixed(2)}`, e('br'), `Y: ${utm.y.toFixed(2)}`
                                    )
                                ),

                                e('button', { type: "submit", disabled: !coords || selIndex === '', className: "w-full btn btn-primary mt-2" }, editId ? "تحديث البيانات" : "حفظ الموقع")
                            ) : e('div', { className: "text-center py-8 text-slate-500" }, "جاري تحميل البيانات...")
                        )
                    ),

                    e('div', { className: "lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden" },
                        e('div', { className: "p-4 border-b flex flex-col sm:flex-row justify-between items-center gap-4" },
                            e('div', { className: "flex gap-4" },
                                e('button', { onClick: () => setActiveTab('pending'), className: activeTab === 'pending' ? 'tab-button tab-button-active' : 'tab-button tab-button-inactive' }, `المتبقي (${pendingList.length})`),
                                e('button', { onClick: () => setActiveTab('collected'), className: activeTab === 'collected' ? 'tab-button tab-button-active' : 'tab-button tab-button-inactive' }, `تم الجمع (${collected.length})`)
                            ),
                            e('div', { className: "flex gap-2" },
                                e('button', { onClick: exportExcel, disabled: !collected.length, className: "btn btn-export text-xs" }, "XLSX تصدير"),
                                isAdmin && e('button', { onClick: exportGeoJSON, disabled: !collected.length, className: "btn btn-secondary text-xs" }, "GeoJSON")
                            )
                        ),

                        e('div', { className: "overflow-x-auto" },
                            activeTab === 'collected' ?
                                (collected.length === 0 ? e('div', { className: "p-8 text-center text-slate-500" }, "لا توجد سجلات مجمعة بعد") :
                                e('table', { className: "w-full text-right" },
                                    e('thead', null, e('tr', null,
                                        e('th', { className: "table-header-cell" }, "العميل"),
                                        e('th', { className: "table-header-cell" }, "SAP كود"),
                                        e('th', { className: "table-header-cell" }, "UTM X"),
                                        e('th', { className: "table-header-cell" }, "UTM Y"),
                                        e('th', { className: "table-header-cell" }, "إجراءات")
                                    )),
                                    e('tbody', null,
                                        collected.map(row => e('tr', { key: row.firebaseId, className: "hover:bg-slate-50" },
                                            e('td', { className: "table-body-cell font-medium" }, row.clientName),
                                            e('td', { className: "table-body-cell" }, row.commercialCode),
                                            e('td', { className: "table-body-cell text-xs font-mono" }, row.utmX || '-'),
                                            e('td', { className: "table-body-cell text-xs font-mono" }, row.utmY || '-'),
                                            e('td', { className: "table-body-cell flex gap-2" },
                                                e('button', { onClick: () => setQrData(row), className: "text-blue-600 hover:underline" }, "QR"),
                                                e('button', { onClick: () => handleEdit(row), className: "text-yellow-600 hover:underline" }, "تعديل"),
                                                isAdmin && e('button', { onClick: () => handleDelete(row.firebaseId), className: "text-red-600 hover:underline" }, "حذف")
                                            )
                                        ))
                                    )
                                ))
                            :
                                (pendingList.length === 0 ? e('div', { className: "p-8 text-center text-green-600 font-bold" }, "تم الانتهاء من جميع المواقع!") :
                                e('table', { className: "w-full text-right" },
                                    e('thead', null, e('tr', null,
                                        e('th', { className: "table-header-cell" }, "م"),
                                        e('th', { className: "table-header-cell" }, "العميل"),
                                        e('th', { className: "table-header-cell" }, "النشاط"),
                                        e('th', { className: "table-header-cell" }, "المحافظة"),
                                        e('th', { className: "table-header-cell" }, "SAP كود")
                                    )),
                                    e('tbody', null,
                                        pendingList.slice(0, 100).map((row, i) => e('tr', { key: i, className: "hover:bg-slate-50" },
                                            e('td', { className: "table-body-cell text-slate-400" }, i + 1),
                                            e('td', { className: "table-body-cell font-medium" }, row.clientName),
                                            e('td', { className: "table-body-cell text-sm" }, row.activity),
                                            e('td', { className: "table-body-cell" }, row.governorate),
                                            e('td', { className: "table-body-cell" }, row.commercialCode)
                                        ))
                                    )
                                ))
                        )
                    )
                )
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(e(React.StrictMode, null, e(MainApp)));
    </script>
</body>
</html>
